#!/bin/bash

BORHAN_FUNCTIONS_RC=/opt/borhan/bin/borhan-functions.rc
if [ ! -r "$BORHAN_FUNCTIONS_RC" ];then
        OUT="${BRIGHT_RED}ERROR:could not find $BORHAN_FUNCTIONS_RC so, exiting..${NORMAL}"
        echo -en $OUT
        exit 3
fi


. $BORHAN_FUNCTIONS_RC
BORHAN_PREFIX=/opt/borhan
APP_DIR=/opt/borhan/app
BORHAN_GROUP=borhan
BORHAN_USER=borhan
APACHE_USER=www-data
BORHAN_VERSION="`dpkg-query -W -f'${Version}' borhan-base|awk -F "+" '{print $1}'`"

ln -sf $BORHAN_PREFIX/app/api_v3/web $BORHAN_PREFIX/app/alpha/web/api_v3
chown $APACHE_USER.borhan -R $BORHAN_PREFIX/web/content/entry $BORHAN_PREFIX/web/content/uploads/  $BORHAN_PREFIX/web/tmp/
find $BORHAN_PREFIX/web/content/entry $BORHAN_PREFIX/web/content/uploads/  $BORHAN_PREFIX/web/tmp/ -type d -exec chmod 775 {} \;
if [ -r $BORHAN_PREFIX/bin/borhan-base-upgrading ];then
        if [ -r "$BORHAN_PREFIX/app/configurations/local.ini" -a -r "$BORHAN_PREFIX/app/configurations/base.ini" ];then
                if [ -r  $BORHAN_PREFIX/bin/borhan-functions.rc ];then
                        . $BORHAN_PREFIX/bin/borhan-functions.rc
                        . /usr/share/debconf/confmodule
                        db_get 'borhan-base/time_zone'
                        if [ -n "$RET" ];then
                                TIME_ZONE=$RET
                        else
                                db_set 'borhan-base/time_zone' $TZGUESS
                                LOCALTIME_MD5=`md5sum /etc/localtime|awk -F " " '{print $1}'`
                                TIME_ZONE=`find /usr/share/zoneinfo -type f | xargs md5sum | grep $LOCALTIME_MD5|awk -F " " '{print $2}'|sed 's@/usr/share/zoneinfo/@@g'`
                        fi
                        db_stop
                        send_install_becon borhan-base-`dpkg-query -W -f'${Version}' borhan-base` $TIME_ZONE install_upgrade
                fi
                sed -i "s@^\(borhan_version\).*@\1 = $BORHAN_VERSION@g" $BORHAN_PREFIX/app/configurations/local.ini
                echo "Regenarating client libs.. this will take up to 2 minutes to complete."
                if service apache2 status;then
                        service apache2 stop
                        service monit stop
			RESTART_APACHE=true
                fi
                # this is read by borhan-sphinx-schema-update.sh to determine rather or not to run
                touch $BORHAN_PREFIX/app/configurations/sphinx_schema_update
                rm -rf $BORHAN_PREFIX/app/cache/*
                php $BORHAN_PREFIX/app/generator/generate.php
                find $BORHAN_PREFIX/app/cache/ $BORHAN_PREFIX/log $BORHAN_PREFIX/var/run -type d -exec chmod 775 {} \;
                find $BORHAN_PREFIX/app/cache/ $BORHAN_PREFIX/log -type f -exec chmod 664 {} \;
                chown -R $BORHAN_USER.$APACHE_USER $BORHAN_PREFIX/app/cache/ $BORHAN_PREFIX/log $BORHAN_PREFIX/var/run
                chmod 775 $BORHAN_PREFIX/web/content

                if [ -n "$RESTART_APACHE" ];then
                        service apache2 start
                fi
                service monit start
		sleep 70
                # we now need CREATE and DROP priv for 'borhan' on borhan.*
                if [ -r /etc/borhan.d/system.ini ];then
                        . /etc/borhan.d/system.ini
			# disbale Default_Akamai_HLS_direct since we want the nginx vod-module profile to be used [ID 1001, system_name: Borhan HLS segmentation]
			echo "update delivery_profile set is_default=0 where id=1 and system_name='Default_Akamai_HLS_direct';"|mysql -h$DB1_HOST -u $DB1_USER -p$DB1_PASS -P$DB1_PORT $DB1_NAME
                        echo "GRANT INSERT,UPDATE,DELETE,SELECT,ALTER,DROP,CREATE ON borhan.* TO 'borhan'@'%';FLUSH PRIVILEGES;"|mysql -h$DB1_HOST -u $SUPER_USER -p$SUPER_USER_PASSWD -P$DB1_PORT
                fi
                php $BORHAN_PREFIX/app/deployment/updates/update.php -i -d >> /opt/borhan/log/kalt_up.log 2>&1
                php $BORHAN_PREFIX/app/deployment/updates/update.php -i -s >> /opt/borhan/log/kalt_up.log 2>&1
                php $BORHAN_PREFIX/app/deployment/base/scripts/installPlugins.php >> /opt/borhan/log/kalt_up.log 2>&1

        fi
	rm $BORHAN_PREFIX/bin/borhan-base-upgrading
	exit 0

fi
set -e
if [ "$1" = "configure" ]; then

	if [ -x "`which php5enmod 2>/dev/null`" ];then
        	php5enmod mcrypt
	fi
	if [ -x /opt/borhan/bin/php7enmod ];then
		/opt/borhan/bin/php7enmod mcrypt
	fi
        . /usr/share/debconf/confmodule
        KALT_CONF_DIR=$APP_DIR/configurations/
        BEGINNERS_TUTORIAL_URL=http://bit.ly/BorhanUploadMenu
        QUICK_START_GUIDE_URL=http://bit.ly/BorhanBmcManual
        FORUMS_URLS=http://bit.ly/BorhanForums
        db_get 'borhan-base/cdn_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/cdn_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/cdn_hostname' || true
        db_go || true
        db_get 'borhan-base/cdn_hostname'
        CDN_HOST=$RET

        db_get 'borhan-base/apache_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/apache_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/apache_hostname' || true
        db_go || true
        #echo "set borhan-base/apache_hostname $CDN_HOST" | debconf-communicate

        db_get 'borhan-base/apache_hostname'
        BORHAN_VIRTUAL_HOST_NAME=$RET

        db_get 'borhan-base/vhost_port'
        if [ -z "$RET" ];then
                db_set 'borhan-base/vhost_port' 80
        fi
        db_input critical 'borhan-base/vhost_port' || true
        db_go || true
        db_get 'borhan-base/vhost_port'
        BORHAN_VIRTUAL_HOST_PORT=$RET
	if [ "$BORHAN_VIRTUAL_HOST_PORT" -eq 443 ];then
		PROTOCOL=https
	else
		PROTOCOL=http
	fi
	if [ "$BORHAN_VIRTUAL_HOST_PORT" -eq 443 -o "$BORHAN_VIRTUAL_HOST_PORT" -eq 80 ];then
        	BORHAN_FULL_VIRTUAL_HOST_NAME="$BORHAN_VIRTUAL_HOST_NAME"
	else
        	BORHAN_FULL_VIRTUAL_HOST_NAME="$BORHAN_VIRTUAL_HOST_NAME:$BORHAN_VIRTUAL_HOST_PORT"
	fi

        db_get 'borhan-base/db_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/db_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/db_hostname' || true
        db_go || true
        db_get 'borhan-base/db_hostname'
        DB1_HOST=$RET

        db_input critical 'borhan-base/db_port' || true
        db_go || true
        db_get 'borhan-base/db_port'
        DB1_PORT=$RET

        db_input critical 'borhan-base/mysql_super_user' || true
        db_go || true
        db_get 'borhan-base/mysql_super_user'
        SUPER_USER=$RET

        db_input critical 'borhan-base/mysql_super_passwd' || true
        db_go || true
        db_get 'borhan-base/mysql_super_passwd'
        SUPER_USER_PASSWD=$RET

        db_get 'borhan-base/dwh_db_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/dwh_db_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/dwh_db_hostname' || true
        #db_set 'borhan-base/dwh_db_hostname' $DB1_HOST
        db_go || true
        db_get 'borhan-base/dwh_db_hostname'
        DWH_HOST=$RET

        db_input critical 'borhan-base/dwh_db_port' || true
        db_go || true
        db_get 'borhan-base/dwh_db_port'
        DWH_PORT=$RET

        db_get 'borhan-base/sphinx_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/sphinx_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/sphinx_hostname' || true
        db_go || true
        db_get 'borhan-base/sphinx_hostname'
        SPHINX_SERVER1=$RET

        db_get 'borhan-base/second_sphinx_hostname'
        if [ -z "$RET" ];then
                db_set 'borhan-base/second_sphinx_hostname' "`hostname`"
        fi
        db_input critical 'borhan-base/second_sphinx_hostname' || true
        db_go || true
        db_get 'borhan-base/second_sphinx_hostname'
        SPHINX_SERVER2=$RET

        db_get 'borhan-base/apache_hostname'
        APACHE_HOST="$RET"
        db_get 'borhan-base/vhost_port'
        APACHE_PORT="$RET"
        db_get 'borhan-base/service_url'
        if [ -z "$RET" ] ;then
		if [ "$APACHE_PORT" -eq 443 ];then
                	DEF_SERVICE_URL="https://$APACHE_HOST"
		elif [ "$APACHE_PORT" -eq 80 ];then
                	DEF_SERVICE_URL="http://$APACHE_HOST"
		else
                	DEF_SERVICE_URL="http://$APACHE_HOST:$APACHE_PORT"
		fi
                db_set 'borhan-base/service_url' $DEF_SERVICE_URL
        fi
        db_input critical 'borhan-base/service_url' || true
        db_go || true
        db_get 'borhan-base/service_url'
        SERVICE_URL=$RET

        db_input critical 'borhan-base/ip_range' || true
        db_go || true
        db_get 'borhan-base/ip_range'
        IP_RANGE=$RET

        db_input critical 'borhan-base/vod_packager_hostname' || true
        db_go || true
        db_get 'borhan-base/vod_packager_hostname'
        VOD_PACKAGER_HOST=$RET

        db_input critical 'borhan-base/vod_packager_port' || true
        db_go || true
        db_get 'borhan-base/vod_packager_port'
        VOD_PACKAGER_PORT=$RET

        db_input critical 'borhan-base/admin_console_email' || true
        db_go || true
        db_get 'borhan-base/admin_console_email'
        ADMIN_CONSOLE_ADMIN_MAIL=$RET


        db_get 'borhan-base/admin_console_passwd'
	ADMIN_CONSOLE_PASSWORD=$RET
        db_get 'borhan-base/admin_console_passwd_again'
	AGAIN_ADMIN_CONSOLE_PASSWORD=$RET
	if [ "$ADMIN_CONSOLE_PASSWORD" != "$AGAIN_ADMIN_CONSOLE_PASSWORD" ];then
		unset ADMIN_CONSOLE_PASSWORD
		unset AGAIN_ADMIN_CONSOLE_PASSWORD
	fi

        while [ -z "$AGAIN_ADMIN_CONSOLE_PASSWORD" ];do
                db_input critical 'borhan-base/admin_console_passwd' || true
                db_go || true
                db_get 'borhan-base/admin_console_passwd'
                ADMIN_CONSOLE_PASSWORD=$RET
                if echo $ADMIN_CONSOLE_PASSWORD | grep -q "/\|&\|>\|<" ;then
                        db_input critical borhan-base/passwd_invalid_char || true
                        db_go
                        unset ADMIN_CONSOLE_PASSWORD
                        continue
                fi


                db_input critical 'borhan-base/admin_console_passwd_again' || true
                db_go || true
                db_get 'borhan-base/admin_console_passwd_again'
                AGAIN_ADMIN_CONSOLE_PASSWORD=$RET
                if [ "$ADMIN_CONSOLE_PASSWORD" != "$AGAIN_ADMIN_CONSOLE_PASSWORD" ];then
                        db_input critical borhan-base/passwd_dont_match || true 
                        db_go
                        unset AGAIN_ADMIN_CONSOLE_PASSWORD

                fi
        done

        db_get 'borhan-base/time_zone'
        if [ -z "$RET" ];then
                db_set 'borhan-base/time_zone' $TZGUESS
                LOCALTIME_MD5=`md5sum /etc/localtime|awk -F " " '{print $1}'`
                TZGUESS=`find /usr/share/zoneinfo -type f | xargs md5sum | grep $LOCALTIME_MD5|awk -F " " '{print $2}'|sed 's@/usr/share/zoneinfo/@@g'`
        fi
        set +e
        TIME_ZONE="$TZGUESS"
        while ! php -r "if (timezone_open('$TIME_ZONE') === false){exit(1);}" >>/dev/null 2>&1;do 
                db_input critical 'borhan-base/time_zone' || true
                db_go || true
                db_get 'borhan-base/time_zone'
                TIME_ZONE=$RET
        done
        set -e
        db_input critical 'borhan-base/env_name' || true
        db_go || true
        db_get 'borhan-base/env_name'
        ENVIRONMENT_NAME=$RET

        db_input critical 'borhan-base/contact_url' || true
        db_go || true
        db_get 'borhan-base/contact_url'
        CONTACT_URL=$RET

        db_input critical 'borhan-base/contact_phone' || true
        db_go || true
        db_get 'borhan-base/contact_phone'
        CONTACT_PHONE_NUMBER=$RET

        db_input critical 'borhan-base/install_analytics_consent' || true
        db_go || true
        db_get 'borhan-base/install_analytics_consent'
        USER_CONSENT=$RET


	if [ "$USER_CONSENT" = true ];then
		db_input critical 'borhan-base/install_analytics_email' || true
		db_go || true
		db_get 'borhan-base/install_analytics_email'
		CONTACT_MAIL=$RET
		echo "USER_CONSENT=1" > $CONSENT_FILE
		echo "CONTACT_MAIL=$CONTACT_MAIL" >> $CONSENT_FILE
	else
		echo "USER_CONSENT=0" > $CONSENT_FILE
	fi
        if [ -z "$DB1_PASS" ];then
		db_input critical 'borhan-base/auto_generate_borhan_mysql_passwd' || true
		db_go || true
		db_get 'borhan-base/auto_generate_borhan_mysql_passwd'
		if [ "$RET" = true ];then
			DB1_PASS=`< /dev/urandom tr -dc A-Za-z0-9 | head -c15`
			set +e
			echo "update mysql.user set password=PASSWORD('$DB1_PASS') WHERE user='borhan';flush PRIVILEGES" | mysql -h$DB1_HOST -P$DB1_PORT -u$SUPER_USER -p$SUPER_USER_PASSWD mysql
			set -e
		else
			while [ -z "$AGAIN_DB1_PASS" ];do
				db_input critical 'borhan-base/borhan_mysql_passwd' || true
				db_go || true
				db_get 'borhan-base/borhan_mysql_passwd'
				DB1_PASS=$RET
				if echo $DB1_PASS | grep -q "/" ;then
					db_input critical borhan-base/passwd_invalid_char || true
					db_go
					unset DB1_PASS
					continue
				fi


				db_input critical 'borhan-base/borhan_mysql_passwd_again' || true
				db_go || true
				db_get 'borhan-base/borhan_mysql_passwd_again'
				AGAIN_DB1_PASS=$RET
				if [ "$DB1_PASS" != "$AGAIN_DB1_PASS" ];then
					db_input critical borhan-base/passwd_dont_match || true 
					db_go
					unset AGAIN_DB1_PASS

				fi
			done
		fi
		if [ -z "$DWH_PASS" ];then
			DWH_PASS=$DB1_PASS
		fi

        fi
        DB1_NAME=borhan
        DB1_USER=borhan

	db_stop
        for INI in /etc/php5/cli/php.ini /etc/php5/apache2/php.ini /opt/borhan/app/configurations/php/apache2/php.ini /opt/borhan/app/configurations/php/cli/php.ini;do
                if [ -r "$INI_FILE" ];then
                        sed -i "s#\(date.timezone\)\s*=.*#\1='$TIME_ZONE'#g" $INI_FILE
                fi
        done

        # no added value in putting this on a separate server..
        SPHINX_DB_HOST=$DB1_HOST
        SPHINX_DB_PORT=$DB1_PORT
	APP_REMOTE_ADDR_HEADER_SALT=`echo $SERVICE_URL|base64 -w0`
        CONF_FILES=`find $KALT_CONF_DIR  -type f -name "*template*"`
        CONF_FILES="$CONF_FILES $BASE_DIR/app/batch/batches/Mailer/emails_en.template.ini $BASE_DIR/app/tests/monitoring/config.template.ini $BASE_DIR/bin/sanity_config.template.ini"
        #if STUDIO_VER=`dpkg-query -W -f'${Version}' borhan-html5-studio |awk -F "+" '{print $1}' 2>/dev/null`;then 
        #       CONF_FILES="$CONF_FILES $BASE_DIR/apps/studio/$STUDIO_VER/studio.template.ini"
        #fi 
        CONF_FILES="$CONF_FILES `find $BASE_DIR/app/plugins/monitor/nagios/config -type f -name "*template*"`"
         
        if [ -d "$BASE_DIR/dwh" ];then
                CONF_FILES="$CONF_FILES `find $BASE_DIR/dwh  -type f -name "*template*"`"
        fi

        # Now we will sed.

        for TMPL_CONF_FILE in $CONF_FILES;do
                CONF_FILE=`echo $TMPL_CONF_FILE | sed 's@\(.*\)\.template\(.*\)@\1\2@'`
                if [ -r $CONF_FILE ];then
                        cp $CONF_FILE $CONF_FILE.backup
                fi
                if `echo $TMPL_CONF_FILE|grep -q template`;then
                        cp  $TMPL_CONF_FILE $CONF_FILE
                fi

                sed  -e "s#@ENVIRONMENT_PROTOCOL@#$PROTOCOL#g" -e "s#@PROTOCOL@#$PROTOCOL#g" -e "s#@CDN_HOST@#$CDN_HOST#g" -e "s#@DB[1-9]_HOST@#$DB1_HOST#g" -e "s#@DB[1-9]_NAME@#$DB1_NAME#g" -e "s#@DB[1-9]_USER@#$DB1_USER#g" -e "s#@DB[1-9]_PASS@#$DB1_PASS#g" -e "s#@DB[1-9]_PORT@#$DB1_PORT#g" -e "s#@TIME_ZONE@#$TIME_ZONE#g" -e "s#@BORHAN_FULL_VIRTUAL_HOST_NAME@#$BORHAN_FULL_VIRTUAL_HOST_NAME#g" -e "s#@BORHAN_VIRTUAL_HOST_NAME@#$BORHAN_VIRTUAL_HOST_NAME#g" -e "s#@SERVICE_URL@#$SERVICE_URL#g" -e "s#@WWW_HOST@#$BORHAN_FULL_VIRTUAL_HOST_NAME#g" -e "s#@SPHINX_DB_NAME@#borhan_sphinx_log#g" -e "s#@SPHINX_DB_HOST@#$SPHINX_DB_HOST#g" -e "s#@SPHINX_DB_PORT@#$DB1_PORT#g" -e "s#@DWH_HOST@#$DWH_HOST#g" -e "s#@DWH_PORT@#$DWH_PORT#g" -e "s#@SPHINX_SERVER1@#$SPHINX_SERVER1#g" -e "s#@SPHINX_SERVER2@#$SPHINX_SERVER2#g" -e "s#@DWH_DATABASE_NAME@#borhandw#g" -e "s#@DWH_USER@#etl#g" -e "s#@DWH_PASS@#$DWH_PASS#g" -e "s#@ADMIN_CONSOLE_ADMIN_MAIL@#$ADMIN_CONSOLE_ADMIN_MAIL#g" -e "s#@WEB_DIR@#$BASE_DIR/web#g" -e "s#@LOG_DIR@#$BASE_DIR/log#g" -e "s#$BASE_DIR/app#$BASE_DIR/app#g" -e "s#@PHP_BIN@#/usr/bin/php#g" -e "s#@OS_BORHAN_USER@#borhan#g" -e "s#@BASE_DIR@#$BASE_DIR#" -e "s#@APP_DIR@#$BASE_DIR/app#g" -e "s#@DWH_DIR@#$BASE_DIR/dwh#g" -e "s#@KETTLE_SH@#/opt/borhan/pentaho/pdi/kitchen.sh#g" -e "s#@EVENTS_LOGS_DIR@#$BASE_DIR/web/logs#g" -e "s#@TMP_DIR@#$BASE_DIR/tmp#g" -e "s#@APACHE_SERVICE@#apache2#g" -e "s#@BORHAN_VIRTUAL_HOST_PORT@#$BORHAN_VIRTUAL_HOST_PORT#g" -e "s#@BIN_DIR@#$BASE_DIR/bin#g" -e "s#@BORHAN_VERSION@#$BORHAN_VERSION#g" -e "s#@SPHINX_SERVER@#$SPHINX_SERVER#g" -e "s#@IMAGE_MAGICK_BIN_DIR@#/usr/bin#g" -e "s#@CURL_BIN_DIR@#/usr/bin#g" -e "s@^\(bin_path_mediainfo\).*@\1=/usr/bin/mediainfo@g" -e "s#@CONTACT_URL@#$CONTACT_URL#g" -e "s#@ENVIRONMENT_NAME@#\"$ENVIRONMENT_NAME\"#g" -e "s#@BEGINNERS_TUTORIAL_URL@#$BEGINNERS_TUTORIAL_URL#g" -e "s#@BEGINNERS_TUTORIAL_URL@#$BEGINNERS_TUTORIAL_URL#g" -e "s#@QUICK_START_GUIDE_URL@#$QUICK_START_GUIDE_URL#g" -e "s#@FORUMS_URLS@#$FORUMS_URLS#g" -e "s#@CONTACT_PHONE_NUMBER@#\"$CONTACT_PHONE_NUMBER\"#g" -e "s#@UNSUBSCRIBE_EMAIL_URL@#$SERVICE_URL/index.php/extwidget/blockMail?e=#g" -e "s#@UICONF_TAB_ACCESS@#SYSTEM_ADMIN_BATCH_CONTROL#g"  -e "s#@EVENTS_FETCH_METHOD@#local#g" -e "s#@HTML5_VER@#$HTML5_VER#g" -e "s#@MONIT_PASSWD@#$DB1_PASS#g" -e "s#@VOD_PACKAGER_HOST@#$VOD_PACKAGER_HOST#g" -e "s#@VOD_PACKAGER_PORT@#$VOD_PACKAGER_PORT#g" -e "s#@IP_RANGE@#$IP_RANGE#g" -e "s#@APP_REMOTE_ADDR_HEADER_SALT@#\"$APP_REMOTE_ADDR_HEADER_SALT\"#g" -i $CONF_FILE
        done


        # these two have passwds in them.
        chown $BORHAN_USER.$APACHE_USER $BASE_DIR/app/configurations/system.ini $BASE_DIR/app/configurations/db.ini $BASE_DIR/app/configurations/batch/batch.ini
        chmod 640 $BASE_DIR/app/configurations/system.ini $BASE_DIR/app/configurations/db.ini $BASE_DIR/app/configurations/batch/batch.ini


        # gen secrets
        ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@#$%^*()_+-=" | head -c20`
        HASHED_ADMIN_SECRET=`echo $ADMIN_SECRET|md5sum`
        ADMIN_SECRET=`echo $HASHED_ADMIN_SECRET|awk -F " " '{print $1}'`

        ADMIN_CONSOLE_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@#$%^*()_+-=" | head -c20`
        HASHED_ADMIN_CONSOLE_PARTNER_SECRET=`echo $ADMIN_CONSOLE_PARTNER_SECRET|md5sum`
        ADMIN_CONSOLE_PARTNER_SECRET=`echo $HASHED_ADMIN_CONSOLE_PARTNER_SECRET|awk -F " " '{print $1}'`

        MONITOR_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_MONITOR_PARTNER_ADMIN_SECRET=`echo $HASHED_MONITOR_PARTNER_ADMIN_SECRET | md5sum`
        MONITOR_PARTNER_ADMIN_SECRET=`echo $HASHED_MONITOR_PARTNER_ADMIN_SECRET | awk -F " " '{print $1}'` 

        MONITOR_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_MONITOR_PARTNER_SECRET=`echo $HASHED_MONITOR_PARTNER_SECRET | md5sum`
        MONITOR_PARTNER_SECRET=`echo $HASHED_MONITOR_PARTNER_SECRET | awk -F " " '{print $1}'` 

        PARTNER_ZERO_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_PARTNER_ZERO_ADMIN_SECRET=`echo $PARTNER_ZERO_ADMIN_SECRET|md5sum`
        PARTNER_ZERO_ADMIN_SECRET=`echo $HASHED_PARTNER_ZERO_ADMIN_SECRET|awk -F " " '{print $1}'`

        PARTNER_ZERO_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_PARTNER_ZERO_SECRET=`echo $PARTNER_ZERO_SECRET|md5sum`
        PARTNER_ZERO_SECRET=`echo $HASHED_PARTNER_ZERO_SECRET|awk -F " " '{print $1}'`


        BATCH_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_BATCH_PARTNER_ADMIN_SECRET=`echo $BATCH_PARTNER_ADMIN_SECRET|md5sum`
        BATCH_PARTNER_ADMIN_SECRET=`echo $HASHED_BATCH_PARTNER_ADMIN_SECRET|awk -F " " '{print $1}'`

        BATCH_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_BATCH_PARTNER_SECRET=`echo $BATCH_PARTNER_SECRET|md5sum`
        BATCH_PARTNER_SECRET=`echo $HASHED_BATCH_PARTNER_SECRET|awk -F " " '{print $1}'`

        MEDIA_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_MEDIA_PARTNER_ADMIN_SECRET=`echo $MEDIA_PARTNER_ADMIN_SECRET|md5sum`
        MEDIA_PARTNER_ADMIN_SECRET=`echo $HASHED_MEDIA_PARTNER_ADMIN_SECRET|awk -F " " '{print $1}'`

        MEDIA_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_MEDIA_PARTNER_SECRET=`echo $MEDIA_PARTNER_SECRET|md5sum`
        MEDIA_PARTNER_SECRET=`echo $HASHED_MEDIA_PARTNER_SECRET|awk -F " " '{print $1}'`

        TEMPLATE_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_TEMPLATE_PARTNER_ADMIN_SECRET=`echo $TEMPLATE_PARTNER_ADMIN_SECRET|md5sum`
        TEMPLATE_PARTNER_ADMIN_SECRET=`echo $HASHED_TEMPLATE_PARTNER_ADMIN_SECRET|awk -F " " '{print $1}'`
        TEMPLATE_PARTNER_ADMIN_PASSWORD="0+`< /dev/urandom tr -dc "A-Za-z0-9_=@%$" | head -c8`=*1"

        TEMPLATE_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_TEMPLATE_PARTNER_SECRET=`echo $TEMPLATE_PARTNER_SECRET|md5sum`
        TEMPLATE_PARTNER_SECRET=`echo $HASHED_TEMPLATE_PARTNER_SECRET|awk -F " " '{print $1}'`

        HOSTED_PAGES_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_HOSTED_PAGES_PARTNER_ADMIN_SECRET=`echo $HOSTED_PAGES_PARTNER_ADMIN_SECRET|md5sum`
        HOSTED_PAGES_PARTNER_ADMIN_SECRET=`echo $HASHED_HOSTED_PAGES_PARTNER_ADMIN_SECRET|awk -F " " '{print $1}'`

        HOSTED_PAGES_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_HOSTED_PAGES_PARTNER_SECRET=`echo $HOSTED_PAGES_PARTNER_SECRET|md5sum`
        HOSTED_PAGES_PARTNER_SECRET=`echo $HASHED_HOSTED_PAGES_PARTNER_SECRET|awk -F " " '{print $1}'`

        PLAY_PARTNER_ADMIN_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_PLAY_PARTNER_ADMIN_SECRET=`echo $PLAY_PARTNER_ADMIN_SECRET|md5sum`
        PLAY_PARTNER_ADMIN_SECRET=`echo $HASHED_PLAY_PARTNER_ADMIN_SECRET|awk -F " " '{print $1}'`

        PLAY_PARTNER_SECRET=`< /dev/urandom tr -dc "A-Za-z0-9_~@$%^*()_+-=" | head -c20`
        HASHED_PLAY_PARTNER_SECRET=`echo $PLAY_PARTNER_SECRET|md5sum`
        PLAY_PARTNER_SECRET=`echo $HASHED_PLAY_PARTNER_SECRET=|awk -F " " '{print $1}'`


        # SQL statement files tokens:
        for TMPL in `find $BASE_DIR/app/deployment/base/scripts/init_content/ -name "*template*"`;do
                DEST_FILE=`echo $TMPL | sed 's@\(.*\)\.template\(.*\)@\1\2@'`
                cp  $TMPL $DEST_FILE
                sed -e "s#@WEB_DIR@#$BASE_DIR/web#g" -e "s#@TEMPLATE_PARTNER_ADMIN_SECRET@#$ADMIN_SECRET#g" -e "s#@ADMIN_CONSOLE_PARTNER_ADMIN_SECRET@#$ADMIN_SECRET#g" -e "s#@MONITOR_PARTNER_ADMIN_SECRET@#$MONITOR_PARTNER_ADMIN_SECRET#g" -e "s#@SERVICE_URL@#$SERVICE_URL#g" -e "s#@ADMIN_CONSOLE_ADMIN_MAIL@#$ADMIN_CONSOLE_ADMIN_MAIL#g" -e "s#@MONITOR_PARTNER_SECRET@#$MONITOR_PARTNER_SECRET#g" -e "s#@PARTNER_ZERO_ADMIN_SECRET@#$PARTNER_ZERO_ADMIN_SECRET#g" -e "s#@BATCH_PARTNER_ADMIN_SECRET@#$BATCH_PARTNER_ADMIN_SECRET#g" -e "s#@MEDIA_PARTNER_ADMIN_SECRET@#$MEDIA_PARTNER_ADMIN_SECRET#g" -e "s#@TEMPLATE_PARTNER_ADMIN_SECRET@#$TEMPLATE_PARTNER_ADMIN_SECRET#g" -e "s#@HOSTED_PAGES_PARTNER_ADMIN_SECRET@#$HOSTED_PAGES_PARTNER_ADMIN_SECRET#g" -e "s#@STORAGE_BASE_DIR@#$BASE_DIR/web#g" -e "s#@DELIVERY_HTTP_BASE_URL@#https://dontknow.com#g" -e "s#@DELIVERY_RTMP_BASE_URL@#rtmp://reallydontknow.com#g" -e "s#@DELIVERY_ISS_BASE_URL@#https://honesttogodihavenoidea.com#g" -e "s/@ADMIN_CONSOLE_PASSWORD@/$ADMIN_CONSOLE_PASSWORD/g"  -e "s#@WWW_HOST@#$BORHAN_FULL_VIRTUAL_HOST_NAME#g" -e "s/@PLAY_PARTNER_ADMIN_SECRET@/$PLAY_PARTNER_ADMIN_SECRET/g"   -e "s#@TEMPLATE_PARTNER_ADMIN_PASSWORD@#$TEMPLATE_PARTNER_ADMIN_PASSWORD#g" -e "s#@PARTNER_ZERO_SECRET@#$PARTNER_ZERO_SECRET#g" -e "s#@BATCH_PARTNER_SECRET@#$BATCH_PARTNER_SECRET#g" -e "s#@ADMIN_CONSOLE_PARTNER_SECRET@#$ADMIN_CONSOLE_PARTNER_SECRET#g" -e "s#@HOSTED_PAGES_PARTNER_SECRET@#$HOSTED_PAGES_PARTNER_SECRER#g" -e "s#@MEDIA_PARTNER_SECRET@#$MEDIA_PARTNER_SECRET#g" -e "s#@PLAY_PARTNER_SECRET@#$PLAY_PARTNER_SECRET#g" -e "s#@TEMPLATE_PARTNER_SECRET@#$TEMPLATE_PARTNER_SECRET#g"  -e "s#@VOD_PACKAGER_HOST@#$VOD_PACKAGER_HOST#g" -e "s#@VOD_PACKAGER_PORT@#$VOD_PACKAGER_PORT#g" -e "s#@IP_RANGE@#$IP_RANGE#g" -i $DEST_FILE
        done


        CONFS=`find $BASE_DIR/app/deployment/base/scripts/init_data/ -name "*template*"`
        CONFS="$CONFS $BASE_DIR/app/tests/monitoring/config.ini"
        for TMPL in $CONFS;do
                DEST_FILE=`echo $TMPL | sed 's@\(.*\)\.template\(.*\)@\1\2@'`
                if `echo $TMPL|grep -q template`;then
                        cp $TMPL $DEST_FILE
                fi
                sed -e "s#@ENVIRONMENT_PROTOCOL@#$PROTOCOL#g" -e "s#@WEB_DIR@#$BASE_DIR/web#g" -e "s#@TEMPLATE_PARTNER_ADMIN_SECRET@#$ADMIN_SECRET#g" -e "s#@ADMIN_CONSOLE_PARTNER_ADMIN_SECRET@#$ADMIN_SECRET#g" -e "s#@MONITOR_PARTNER_ADMIN_SECRET@#$MONITOR_PARTNER_ADMIN_SECRET#g" -e "s#@SERVICE_URL@#$SERVICE_URL#g" -e "s#@ADMIN_CONSOLE_ADMIN_MAIL@#$ADMIN_CONSOLE_ADMIN_MAIL#g" -e "s#@MONITOR_PARTNER_SECRET@#$MONITOR_PARTNER_SECRET#g" -e "s#@PARTNER_ZERO_ADMIN_SECRET@#$PARTNER_ZERO_ADMIN_SECRET#g" -e "s#@BATCH_PARTNER_ADMIN_SECRET@#$BATCH_PARTNER_ADMIN_SECRET#g" -e "s#@MEDIA_PARTNER_ADMIN_SECRET@#$MEDIA_PARTNER_ADMIN_SECRET#g" -e "s#@TEMPLATE_PARTNER_ADMIN_SECRET@#$TEMPLATE_PARTNER_ADMIN_SECRET#g" -e "s#@BORHAN_VERSION@#$BORHAN_VERSION#g" -e "s#@HOSTED_PAGES_PARTNER_ADMIN_SECRET@#$HOSTED_PAGES_PARTNER_ADMIN_SECRET#g" -e "s#@STORAGE_BASE_DIR@#$BASE_DIR/web#g" -e "s#@DELIVERY_HTTP_BASE_URL@#https://dontknow.com#g" -e "s#@DELIVERY_RTMP_BASE_URL@#rtmp://reallydontknow.com#g" -e "s#@DELIVERY_ISS_BASE_URL@#https://honesttogodihavenoidea.com#g"  -e "s/@ADMIN_CONSOLE_PASSWORD@/$ADMIN_CONSOLE_PASSWORD/g"  -e "s/@PLAY_PARTNER_ADMIN_SECRET@/$PLAY_PARTNER_ADMIN_SECRET/g" -e "s#@WWW_HOST@#$BORHAN_FULL_VIRTUAL_HOST_NAME#g" -e "s#@TEMPLATE_PARTNER_ADMIN_PASSWORD@#$TEMPLATE_PARTNER_ADMIN_PASSWORD#g" -e "s#@HOSTED_PAGES_PARTNER_SECRET@#$HOSTED_PAGES_PARTNER_SECRER#g" -e "s#@MEDIA_PARTNER_SECRET@#$MEDIA_PARTNER_SECRET#g" -e "s#@PLAY_PARTNER_SECRET@#$PLAY_PARTNER_SECRET#g" -e "s#@TEMPLATE_PARTNER_SECRET@#$TEMPLATE_PARTNER_SECRET#g" -e "s#@PARTNER_ZERO_SECRET@#$PARTNER_ZERO_SECRET#g" -e "s#@BATCH_PARTNER_SECRET@#$BATCH_PARTNER_SECRET#g" -e "s#@ADMIN_CONSOLE_PARTNER_SECRET@#$ADMIN_CONSOLE_PARTNER_SECRET#g"  -e "s#@VOD_PACKAGER_HOST@#$VOD_PACKAGER_HOST#g" -e "s#@VOD_PACKAGER_PORT@#$VOD_PACKAGER_PORT#g" -e "s#@IP_RANGE@#$IP_RANGE#g" -i $DEST_FILE 
        done
        if [ -f "$BORHAN_PREFIX/app/configurations/system.ini" ];then
                mkdir -p /etc/borhan.d
                ln -sf $BORHAN_PREFIX/app/configurations/system.ini /etc/borhan.d/system.ini
        fi

        #db_input critical 'borhan-base/generating_client_libs' || true
	if service apache2 status;then
		service apache2 stop
		RESTART_APACHE=true
		service monit stop
	fi
        rm -rf $BORHAN_PREFIX/app/cache/*
        php $BASE_DIR/app/generator/generate.php >> $BASE_DIR/log/generate.php.log 2>&1

	if [ -n "$RESTART_APACHE" ];then
		service apache2 start
	fi
        set +e


        ln -sf $BASE_DIR/app/configurations/logrotate/borhan_base /etc/logrotate.d/
        ln -sf $BASE_DIR/app/configurations/logrotate/borhan_api /etc/logrotate.d/
	if [ -d "/etc/php5/mods-available" ];then
        	ln -sf $APP_DIR/configurations/php/borhan.ini /etc/php5/mods-available/zz-borhan.ini
	fi
	if [ -d "/opt/borhan/app/configurations/php/mods-available" ];then
        	ln -sf $APP_DIR/configurations/php/borhan.ini /opt/borhan/app/configurations/php/mods-available/zz-borhan.ini
	fi
        touch  "$BASE_DIR/app/base-config.lock"

        find $BASE_DIR/app/cache/ $BASE_DIR/log -type d -exec chmod 775 {} \; 
        find $BASE_DIR/app/cache/ $BASE_DIR/log -type f -exec chmod 664 {} \; 
        chown -R $BORHAN_USER.$APACHE_USER $BASE_DIR/app/cache/ $BASE_DIR/log
        chmod 775 $BASE_DIR/web/content
        if [ -d /usr/lib/red5/webapps/oflaDemo ];then
                ln -sf $BASE_DIR/web/content/webcam /usr/lib/red5/webapps/oflaDemo/streams
        fi
        BMC_PATH=`ls -ld $BASE_DIR/web/flash/bmc/v* 2>/dev/null|awk -F " " '{print $NF}' |tail -1`
        BMC_LOGIN_PATH=`ls -ld $BASE_DIR/web/flash/bmc/login/v* 2>/dev/null|awk -F " " '{print $NF}' |tail -1`
        if [ -d "$BMC_PATH" -a -d "$BMC_LOGIN_PATH" ];then
                BMC_VERSION=`basename $BMC_PATH`
                BMC_LOGIN_VERSION=`basename $BMC_LOGIN_PATH`
                sed -i "s#\(@BMC_VERSION@\)#$BMC_VERSION#g" $BASE_DIR/bin/sanity_config.ini
                sed -i "s#\(@BMC_LOGIN_VERSION@\)#$BMC_LOGIN_VERSION#g" $BASE_DIR/bin/sanity_config.ini
        fi


        #echo -e "${BRIGHT_BLUE}Configuration of $BORHAN_VERSION finished successfully!${NORMAL}"
        send_install_becon `basename $0` $TIME_ZONE install_success 0
        echo "
SERVICE_URL=$SERVICE_URL
SPHINX_HOST=$SPHINX_SERVER1
DB1_PORT=$DB1_PORT
SUPER_USER=$SUPER_USER
SUPER_USER_PASSWD=\"$SUPER_USER_PASSWD\"
BORHAN_VIRTUAL_HOST_NAME=$BORHAN_FULL_VIRTUAL_HOST_NAME
RED5_HOST=$RED5_HOST
">> $BASE_DIR/app/configurations/system.ini
fi

